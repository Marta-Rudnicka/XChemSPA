# XChemSPA
## Documentation and specification for further development

This Django project is a part of a larger XChemSPA application, and it is meant to coordinate data exchange while crystals are soaked, harvested and mounted. The compound selection part is covered by [webSoakDB: ](https://github.com/Marta-Rudnicka/webSoakDB/tree/main/documentation). The technologies used are the same, except this application does not use RDkit or bokeh.

Unlike the webSoakDB documentation, this documentation details is organised mostly by functionality, not by django app.
- [What XChemSPA does](#exp)
- [Django apps and other directories](#apps)
- [Data models](#models)

## Outline of the processes managed by XChemSPA <a name="exp"></a>

There are two main kinds of experiments managed by the application, that will be referred to as **solvent characterization** and **compound screen**.

In **solvent characterization** experiments, crystals are exposed to solvents and cryoprotectants only to establish the right solvent, its concentration and the need for cryoprotectant in the actual experiment. In a **compound screen**, the crystals are soaked in the compound solutions from fragment libraries. Most of the experiment is the same in both cases, except for the beginning.

This description covers all the functionalities, included those not implemented yet. The documentation for the specific features will cover what is already done, and what needs to be added.

1. First stage: generating compound or solvent data

For compound screens, the data begins with importing compound data. The selection of libraries and compounds is done in the webSoakDB application, and involves library inventory data. In XChemSPA, in the beginning of the experiment, user imports the selection data - which creates copies of the data from the inventory. Copying is necessary because the inventory data changes over time (for example, the library plate may run out of a compound and be marked as empty), while the experimental data needs to record what exactly was used in the experiment.

In case of solvent characterization, the data is generated using the application itself. The user enters what solvents, concentrations and cryoprotectant will be tested and the right data is generated based on the user input.

2. Importing crystal data.

The crystal data is imported from CSV files generated by TexRank software, which manages imaging of the crystals and determining how suitable they are for the experiment.

2.5 Secondary crystal selection.

The initial selection of crystals to be used in the experiment is done outside of XChemSPA, while user inspects the crystal photos for the first time and does not know how many crystals of acceptable quality are available. After making the initial choices and importing the data to XChemSPA, user has a chance to recosider the selection - for example if there are more than enough crystals to test all the desired compounds, the user might decide to reject a few more, poorer quality crystals in XChemSPA.

3. Matching crystals and compounds/solvents together and batches

Once the data of both the crystals and the compounds/solvents is created, it needs to be linked together: one particular compound/compound combination/solvent has to be assigned to one particular crystal. In the same process, batches are created.

One batch is a group of crystals that goes in the Echo dispenser together, for soaking in compound solutions or applying cryoprotectant. For every batch, a separate Echo file needs to be created, whith specific instructions on which compound should be dispensed into which well with a crystal.

One batch can only contain crystals from one crystallisation plate, and compounds from one library plate. It can either cover the whole plate-plate combination, or the combination can be divided into maller batches of specific size.

In the XChemSPA user interface, user matches library plates to crystallization plates and decided on the batch size. Based on that choice, the application automatically generates batches and matches specific compounds/compound combinations/solvents to crystals.

4. Soaking

The Echo dispenser requires a CSV input file containing specific instructions: which compound/solvent to dispense into which well with the crystal, and how much of it. In the soaking interface in XChemSPA, user specifies the desired concentrations etc. for selected batches. Based on that input, and the batch data created previously, XChemSPA generates input files for Echo. The information about used volumes, concentrations etc. as well as timestamps, soaking duration etc. are generated and saved by XChemSPA.

5. Cryo

Only some experiments require the usage of cryoprotectant. The interface and proces for applying it is similar to dispensing fragments into the crystallization plate: Based on user input and some of the data in the database, XChemSPA generates Echo input files to guide the process of adding cryoprotectant to the sample.

6. Harvesting

After the crystals are soaked, they are harvested and mounted onto pins. The processed is tracked using the Shifter software.

First, XChemSPA generates a CVS file that is used as the Shifter input. During the mounting process, Shifter records information related to the mounting process, which is then added to the CSV file and imported to XChemSPA again.

7. Barcode reader

The positions of pins within pucks holding them are recorder using barcode reader software. It is also imported as a SCV file and added to XChemSPA sample data

7.5.

In case of solvent characterization experiment, user can record the conclusion from solvent characterization for future reference. The data is not used in any of the processes - itis only stored in XChemSPA to make it easier for the user to find the findings when needed.

8. IspyB export

All the information recorded, created and tracked by XChemSPA is exported to IspyB

## Basic information about the application

### Django apps in the project<a name="apps"></a>

- XChemSPA_frontend - a single-page ReactJS application providing the user interface for the application; most of the data that is generated by XChemSPA is computed on the front-end side

- XChemSPA_backend - Django views that mainly handle data imports and exports (parsing and producing CSV files etc.)

- API - webAPI written using Django REST Framework providing the endpoints used by XChemSPA_frontend

### Other directories

- tools - various helper functions used by the views, grouped by functionality
- tests - unit tests

## Models <a name="models"></a>

### Crystal

Represents one physical Crystal. Some of the attributes in this model are not used in XChemSPA at all. The attributes used are:

- `crystal_name` - a string assigned to the crystal during harvesting; in the beginning it's None/NULL
- `project` 
- `crystal_plate` - an instance of CrystalPlate: crystallization plate from which the crystal comes

__Data imported from TexRank__
- `well `- the well in the crystallization plate in which the crystal is located in the beginning of the experiment
- `echo_x `- coordinates inside the well 
- `echo_y` -
- `score` - a score related to the quality of the crystal

### SpaCompound
(Understanding this model and its usage requires understanding [models used by the inventory](https://github.com/Marta-Rudnicka/webSoakDB/blob/main/documentation/README.md#models).)
An instance of compound used in an experiment. Because the compound inventory constantly changes, the experimental data cannot point to any instance SourceWell - the information about the compound used in the experiment at the time in the experiment needs to be preserved. SpaCompound preserves the relevant information - it serves as a "snapshot" of the state of the source wells used in the experiment

__Attributes__
- `project `
- `library_name` (copied from `SourceWell.library_plate.library.name`)
- `library_plate` (copied from `SourceWell.library_plate.barcode`)
- `well` (copied from `SourceWell.well`)
- `code` (copied from `SourceWell.compound.code`)
- `smiles` (copied from `SourceWell.compound.smiles`)

### CompoundCombination

A group of compounds that are mixed together and used on one crystal at the same time ("cocktail"). Created based on user-submitted csv file.

__Attributes__
- `project`
- `number` - an int used to identify the combination in a project, used keeping track of which compounds are mixed together
- `compounds` - a many-to-many field referring to SpaCompound instances representing the compounds used in the combination
- `related_crystals` - an attribute used in combi-soaks. If compounds are combined based on the results of previous soaks, related_crystals stores the names of the crystals based on which particular compounds were selected to be applied together

### Batch

A group of samples that undergo soaking and adding cryo together. The model stores all the values that are common for all the samples in the batch. The data in this model is generated by XChemSPA during the experiment

There are slight differences between solvent characterization experiments, and experiments involving compounds, therefore batches store more or less data depending on the type of the experiment. The basic batch data, common to all experiments, are stored in attributes present in SolventBatch. For compound screens, the common data also include additional attributes, which are stored in the abstract class SoakAndCryoValues. The Batch class inherits from both these classes.

__attributes from SolventBatch__
- `number`- the number of the batch (unique within the project)
- `project` 
- `soak_status` - whether the sample is before, ready for soaking, finished etc.
- `soak_timestamp` - when date soaking started
- `soaking_time` - duration of the soak
- `cryo_timestamp` - when cryoprotectant was applied
- `cryo_status` - similar to soak status

__attribute from SoakAndCryoValues__
- `crystal_plate` - crystallization plate from which the crystals in the batch come (used to access drop_volume used in certain calculations for the whole batch)
- `solv_frac` - solvent concentration in %
- `stock_conc` - solvent stock concentraition in ???
- `cryo_frac` - cryoprotectant concentration in %
- `cryo_stock_frac `??
- `cryo_location` - the well from which cryoprotectant is to be dispenses
- `soak_vol` - the volume of transfered compound solution
- `expr_conc` - compound concentrarion
- `cryo_transfer_vol` - the volume of transfered cryoprotectant


### SolventTestingData

(For experiments in which solvent tolerance of the crystals is tested before applying the fragment library) - data related to the solvent used on a crystal.

While attributes from SoakAndCryoValues are the same for the whole batch in a compound screen, when only solvents are tested, these values are different for each crystal - that is why
in a compound screen they are tied to the batch, and during solvent characterization they are individual to each sample

__Attributes__
- `solvent_name`
- `batch` - an instance of SolventBatch (explained in detail below)
- all the attributes from SoakAndCryoValues

## Lab

One instance of Lab represents one sample in the experiment. The model serves as a "hub" that joins together all the data about the sample, using multiple foreign keys (apart from storing some additional data).

Attributes:
- `crystal_name` - an instance of Crystal (the name stayed unchanged from the original schema )
- `project` - the project to which the experiment on the sample belongs to

__What the crystal is exposed to__

There are three types of experiments important for understaning the model: exposing the crystal to one compound, exposing the crystal to multiple compounds (cocktail or combi-soak), or exposing the crystal just to the solvent. Depending on the type of experiment, one of the following three attribute is used, and the rest is None/Null.

- `single_compound` - an instance of SpaCompound; this attribute is used when the crystal is exposed to just one compound in a library (the most common type of sample)
- `compound_combination` - an instance of CompoundCombination; this attribute is used when the crystal is soaked in a mixture of compounds
- `solvent_data` - an instance of SolventTestingData - when the crystal is exposed to the solvent alone

__batch__

- `batch` - an instance of Batch - a collection of samples that are processed together (and generate the same data for each sample); None/NULL in case of a solvent testing experiment
    
__Shifter data (crystal harvesting data)__

- `harvest_status`
- `mounting_result`
- `mounting_time`
- `arrival_time`
- `mounted_timestamp`

__Tracking the sample after mounting the crystal__
- `data_collection_visit` 
- `puck` 
- `position` 
- `pin_barcode`

__Other__
- `ispyb_status`


### CrystalPlate

Crystallization plate in which the crystals are kept in the beginning of the experiment:

- `name`
- `drop_volume` - used in calculation of volumes and concentration in the dispenser #TODO find out what exactly that means
- `plate_type` 
- `project`

